/**
 * This ruleset enforces a strict user-ownership model for the EcoSweep application.
 *
 * Core Philosophy:
 * The security model is centered on data privacy and integrity. Each user (resident)
 * has a dedicated document for their personal information, and they are the only
 * one who can access or modify it. This prevents any user from seeing or altering
 * another user's data.
 *
 * Data Structure:
 * All resident data is stored in a top-level collection named 'residents'. Each
 * document in this collection is identified by the resident's unique user ID (UID),
 * following the pattern /residents/{residentId}.
 *
 * Key Security Decisions:
 * - Strict Ownership: All operations (read, create, update, delete) on a
 *   /residents/{residentId} document are restricted to the authenticated user
 *   whose UID matches the {residentId} in the path.
 * - User Listing Disabled: To protect the privacy of all residents, querying or
 *   listing the entire 'residents' collection is explicitly disallowed.
 * - Relational Integrity: On creation, the document's internal 'id' field must
 *   match the document's ID ({residentId}) to ensure a consistent link between
 *   the user's authentication credentials and their data. This 'id' field is
 *   enforced as immutable on update.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    // ------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's ID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document. Used for update and delete.
     * Denies requests trying to modify a document that doesn't exist.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates that the 'id' field within a new resident document matches the
     * document's ID from the path. This enforces relational integrity at creation.
     */
    function hasValidResidentId(residentId) {
      return request.resource.data.id == residentId;
    }
    
    /**
     * Ensures that the 'id' field of a resident document cannot be changed after
     * it has been created.
     */
    function hasImmutableId() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * @description Each resident can manage their own data, but cannot see other residents.
     * @path /residents/{residentId}
     * @allow (create) A new user with UID 'user_abc' creating their own document at '/residents/user_abc'.
     * @allow (get) An authenticated user with UID 'user_abc' reading their own document at '/residents/user_abc'.
     * @allow (update) An authenticated user with UID 'user_abc' updating their own document at '/residents/user_abc'.
     * @deny (list) Any user, authenticated or not, attempting to list all documents in the '/residents' collection.
     * @deny (get) A user with UID 'user_xyz' attempting to read the document at '/residents/user_abc'.
     * @principle Restricts access to a user's own data tree (Self-Creation and Ownership).
     */
    match /residents/{residentId} {
      allow get: if isOwner(residentId);
      allow list: if false;
      allow create: if isOwner(residentId) && hasValidResidentId(residentId);
      allow update: if isExistingOwner(residentId) && hasImmutableId();
      allow delete: if isExistingOwner(residentId);
    }
  }
}